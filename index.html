<!DOCTYPE html>
<html class="dark" lang="th">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>My Staked Assets - Retro Space</title>

    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ad2bee",
                        "primary-glow": "#c65cf2",
                        "background-light": "#f7f6f8",
                        "background-dark": "#150b1a",
                        "surface": "#2b1933",
                        "surface-light": "#3c2348",
                        "accent-text": "#b792c9",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    }
                },
            },
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #150b1a; }
        ::-webkit-scrollbar-thumb { background: #3c2348; border-radius: 3px; }
        .glass-panel { background: rgba(43, 25, 51, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .neon-border { box-shadow: 0 0 10px rgba(173, 43, 238, 0.2); border: 1px solid rgba(173, 43, 238, 0.3); }
        body { min-height: max(884px, 100dvh); }
    </style>
</head>
<body class="antialiased">
    <div class="relative flex h-auto min-h-screen w-full flex-col bg-background-dark overflow-x-hidden font-display text-white">
        <div class="fixed inset-0 pointer-events-none z-0 opacity-20" style="background-image: radial-gradient(#ad2bee 1px, transparent 1px); background-size: 30px 30px;"></div>

        <div class="sticky top-0 z-50 glass-panel px-4 py-3 flex items-center justify-between shadow-lg">
            <button class="flex size-10 items-center justify-center rounded-full hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined text-white">arrow_back</span>
            </button>
            <h1 class="text-lg font-bold tracking-tight uppercase">MKE Combustion</h1>
            <button id="btn-connect-wallet" class="flex items-center gap-2 bg-primary hover:bg-primary-glow px-4 py-2 rounded-full border border-primary/30 transition-all">
                <span class="material-symbols-outlined text-white text-[18px]">account_balance_wallet</span>
                <span class="text-xs font-bold tracking-wider text-white">CONNECT</span>
            </button>
        </div>

        <div class="relative z-10 flex flex-col gap-6 p-4">
            <div class="w-full bg-surface rounded-2xl p-5 neon-border relative overflow-hidden group">
                <div class="flex flex-col gap-4 relative z-10">
                    <div class="flex items-start justify-between">
                        <div class="flex gap-4">
                            <div class="w-16 h-16 rounded-xl overflow-hidden border-2 border-primary/50">
                                <img alt="Rank" class="w-full h-full object-cover" src="https://via.placeholder.com/150"/>
                            </div>
                            <div class="flex flex-col justify-center">
                                <p class="text-accent-text text-xs font-bold tracking-widest uppercase mb-1">Current Clearance</p>
                                <h2 class="text-2xl font-bold leading-none text-white" id="display-tier">Recruit</h2>
                                <p class="text-white/60 text-sm mt-1" id="display-tier-number">Tier 0</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-primary animate-pulse">rocket_launch</span>
                    </div>

                    <div class="mt-2">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-sm font-medium text-white">Progress to Next Tier</span>
                            <span class="text-xs font-mono text-primary" id="progress-text">0 / 1000 MKE</span>
                        </div>
                        <div class="h-3 w-full bg-[#150b1a] rounded-full overflow-hidden border border-white/5">
                            <div class="h-full bg-primary" id="progress-bar" style="width: 0%;"></div>
                        </div>
                        <div class="flex justify-between mt-2">
                            <p class="text-xs text-white/40">Next Reward: Boost Increase</p>
                            <p class="text-xs text-accent-text font-bold" id="progress-percent">0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-gradient-to-br from-primary/20 to-primary/5 p-4 rounded-xl border border-primary/40">
                    <div class="flex items-center gap-2 text-primary"><span class="material-symbols-outlined">wallet</span><span class="text-xs font-bold uppercase">Balance</span></div>
                    <p class="text-xl font-bold" id="display-wallet-balance">-- MKE</p>
                </div>
                <div class="bg-surface-light p-4 rounded-xl border border-white/5">
                    <div class="flex items-center gap-2 text-accent-text"><span class="material-symbols-outlined">local_fire_department</span><span class="text-xs font-bold uppercase">Burned</span></div>
                    <p class="text-xl font-bold" id="display-burned">0 MKE</p>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button id="btn-ignite" class="w-full h-14 bg-primary hover:bg-primary-glow rounded-xl flex items-center justify-center gap-2 text-white font-bold tracking-wider shadow-lg">
                    <span class="material-symbols-outlined">local_fire_department</span>
                    <span>IGNITE (BURN MORE)</span>
                </button>
                <button id="btn-claim" class="w-full h-12 bg-surface hover:bg-surface-light border border-primary/30 rounded-xl flex items-center justify-center gap-2 text-accent-text font-bold tracking-wider">
                    <span class="material-symbols-outlined">download</span>
                    <span>CLAIM REWARDS</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const SEPOLIA_CHAIN_ID = '0xaa36a7';
        const SEPOLIA_CHAIN_ID_DECIMAL = 11155111;
        const contractAddress = "0x2D9C2f2d48297CFDeAF79b66c29212A8880Ae7bC";
        const tokenAddress = "0x3A2E8B9F4073357597A8f80905D6a3E2197179F2";

        const contractABI = [
            "function upgradeTier(uint256 amount) public",
            "function claimCredits() public",
            "function userInfo(address user) public view returns (uint256 tier, uint256 balance, uint256 lastClaim)"
        ];

        const tokenABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)"
        ];

        let provider, signer, contract, tokenContract, userAddress, isConnected = false;

        // FUNCTIONS
        async function checkAndSwitchNetwork() {
            const network = await provider.getNetwork();
            if (network.chainId !== SEPOLIA_CHAIN_ID_DECIMAL) {
                try {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: SEPOLIA_CHAIN_ID }] });
                    return true;
                } catch (err) {
                    alert("กรุณาสลับเครือข่ายเป็น Sepolia Testnet");
                    return false;
                }
            }
            return true;
        }

        async function initWeb3() {
            if (!window.ethereum) return alert("Please install MetaMask");
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                if (!(await checkAndSwitchNetwork())) return;
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                tokenContract = new ethers.Contract(tokenAddress, tokenABI, signer);
                
                isConnected = true;
                updateUI();
                updateDashboard();
                alert("เชื่อมต่อสำเร็จ!");
            } catch (error) { console.error(error); }
        }

        function updateUI() {
            const btn = document.getElementById('btn-connect-wallet');
            if (isConnected) {
                btn.innerHTML = `<span class='text-xs'>${userAddress.substring(0,6)}...${userAddress.substring(38)}</span>`;
                btn.classList.replace('bg-primary', 'bg-green-600');
            }
        }

        async function updateDashboard() {
            if (!isConnected) return;
            const info = await contract.userInfo(userAddress);
            const balance = ethers.utils.formatEther(info.balance);
            const tier = info.tier.toNumber();
            
            document.getElementById('display-burned').innerText = `${parseFloat(balance).toFixed(2)} MKE`;
            document.getElementById('display-tier').innerText = tier === 0 ? "Recruit" : "Tier " + tier;
            
            updateProgressBar(tier, parseFloat(balance));
            
            const tokenBal = await tokenContract.balanceOf(userAddress);
            document.getElementById('display-wallet-balance').innerText = `${parseFloat(ethers.utils.formatEther(tokenBal)).toFixed(2)} MKE`;
        }

        function updateProgressBar(tier, burned) {
            const thresholds = [0, 1000, 5000, 10000, 20000];
            const nextTier = tier + 1;
            if (nextTier >= thresholds.length) return;

            const nextThreshold = thresholds[nextTier];
            const prevThreshold = thresholds[tier];
            const percentage = Math.min(100, ((burned - prevThreshold) / (nextThreshold - prevThreshold)) * 100);

            document.getElementById('progress-bar').style.width = percentage + "%";
            document.getElementById('progress-text').innerText = `${burned.toFixed(0)} / ${nextThreshold} MKE`;
            document.getElementById('progress-percent').innerText = Math.floor(percentage) + "%";
        }

        async function handleIgnite() {
            if (!isConnected) return alert("Connect Wallet First");
            const amount = prompt("จำนวน MKE ที่จะ Burn:", "1000");
            if (!amount) return;
            try {
                const tx = await contract.upgradeTier(ethers.utils.parseEther(amount));
                await tx.wait();
                alert("Burn Success!");
                updateDashboard();
            } catch (e) { alert("Error: " + e.message); }
        }

        async function handleClaim() {
            if (!isConnected) return;
            try {
                const tx = await contract.claimCredits();
                await tx.wait();
                alert("Claim Success!");
                updateDashboard();
            } catch (e) { alert("Error: " + e.message); }
        }

        // STARTUP
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btn-connect-wallet').onclick = initWeb3;
            document.getElementById('btn-ignite').onclick = handleIgnite;
            document.getElementById('btn-claim').onclick = handleClaim;
        });
    </script>
</body>
</html>
